<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>
    <title>Monitoramento de conexões</title>
  </head>
    <h1 Style="height: 3vh">Conexão Estação Central x Bico de bomba</h1>
    <div id="Buttons">
    <button Style="height: 2.4vh" id="ToAddNozzle" onclick=DetectNozzle()>Adicionar Bico</button>
    <button Style="height: 2.4vh" id="ToAddPump" onclick=DetectPump()>Adicionar Bomba</button>
    <button Style="height: 2.4vh" id="ToRemove"onclick=Remove()>Remover</button>
    </div>
    <!--Connecting this file to socket.io
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-3.2.1.min.js"></script>-->
  <div id="addedEquipments">
    <div id="addedPumps" title="Bombas Ativas">
      <div id="addedPump1"></div>
      <div id="addedPump2"></div>
    </div>
    <div class="addedNozzles">
      <div id="Pump1AddedNozzles"></div>
      <div id="Pump2AddedNozzles"></div> 
    </div>
  </div>
  <div id="detectedEquipments">
    <div id="detectedPumps">Bombas detectadas</p></div>
    <div id="detectedNozzles">Bicos detectados</p></div>   
  </div>  
  <div id="centerStation">
    <footer id="information"></footer>
  </div>
  <div id="rightColumn">
    <div id="pumpNozzle"></div>
  </div>

  <script>
    var detectedPumpCounter = 0;  //Counter to indentify the amount of detected Pumps.
    var activePumps = 0;  //Counter to identify the amount of activated Pumps.
    var detectedNozzleCounter = 0;  //Counter to identify the amount of nozzle that was detected.
    var lastPumpClick=0;  //Register of the number of the last pump clicked.
    var nozzlesConnectedToPump1=0;  //Counter to indentify the quantity o nozzles was connected to the Pump1.
    var nozzlesConnectedToPump2=0;  //Counter to indentify the quantity o nozzles was connected to the Pump2.
    /*
    var centerStationFound = false;
    var pumpNozzleFound = false;
    const socket = io(); //Instancing the socket.io calling its constructor.
    //Checking for new connections by socket.io
    socket.on("connect", function ()
    {
    //Adding the information to the last position in the div object to be shown.
      $("#information").append("Server connected " + "<br>");
      //Sending a message to server confirming the Grafic interface connection.
      socket.emit("DeviceFound", "Graphic interface connected.");
    });
    //Printing the messages received from server by socket.io in the div object.

    socket.on("Scan finished", function () 
    {
      if (centerStationFound && DeviceName != "Estação Central") 
      {
        CenterStationRemoval();
      }
    });
    //socket.on("DeviceFound", CenterStationCreation());
    socket.on("DeviceFound", function (DeviceName)
    {
      //Adding the message to the last position in the div object to be shown.
      switch (DeviceName)
      {
        case "Estação Central":
        if (centerStationFound === false) 
        {
          centerStationFound = true;
          CenterStationCreation();
          break;
        }
        break;

        case "Bico":
          if (pumpNozzleFound === false) 
          {
            pumpNozzleFound = true;
            PumpNozzleCreation();
            break;
          }
          break;

          default:
            console.log("Not detected.");
            break;
      }
    });

    function CenterStationCreation() 
    {
      var image = document.createElement("img");
      image.src = "/img/CenterStation.jpg";
      image.alt = "Center Station";
      document.getElementById("centerStation").appendChild(image);
      addEventListener("click", function () 
      {
        console.log("cliquei aqui");
      });
    }

    function CenterStationRemoval() 
    {
      var element = document.querySelector("#centerStation > *:last-child");
      if (element) 
      {
        element.remove();
      }
    }

    function PumpNozzleCreation() 
    {
      var image = document.createElement("img");
      image.src = "/img/PumpNozzle.jpg";
      image.alt = "Pump Nozzle";
      document.getElementById("pumpNozzle").appendChild(image);
      addEventListener("click", function () 
      {
        console.log("cliquei aqui");
      });
    }
  */
  
  function DetectPump() //Function to create Pump. 
  {
    lastButtonClick = "Adicionar Bomba";  //Inform the system that the Adicionar Bomba button was clicked.
    detectedPumpCounter++;  //Inform the system that a new pump was detected.
    if(detectedPumpCounter <= 2)  //Checking the times that the ElementCreation function be called for this Pump.
    {
      //Function to create the elements, using as parameter the object type and label title (dynamically created).
      elementCreation("pump", "Bomba " + detectedPumpCounter);  
    }
  }

  function DetectNozzle() //Function to create nozzle.
  {
    lastButtonClick = "Adicionar Bico";  //Inform the system that the Adicionar Bico button was clicked.
    detectedNozzleCounter++;  //Inform the system that a new nozzle was detected.
    if (detectedNozzleCounter <= 8)
    {
      //Nozzle creation with elementCreation function.
      elementCreation("nozzle", "Bico " + detectedNozzleCounter)
    }
  }

  function elementCreation(type, title) //Function to a detected object
  {
    var image = document.createElement("img");  //Creation of img object be assigned to the image variable.
    var figure = document.createElement("figure");  //Creation of figure object be assigned to the figure variable.
    var caption = document.createElement("figcaption");  //Creation of figcaption object be assigned to the caption variable.
    image.alt, image.title, caption.textContent = title;  //Assignment of title content to image.alt, image.title and caption textContent.
        
    switch (type) //Directing the execution according to the supplied type.
    {
      case "pump":  //In case of pump type.
      image.src = "/img/CenterStation.jpg"; //The source of image is being defined in the image variable.
      image.className = "PumpDetected"; //The class name is being set to style the image.(linking the correct style to the image).
      caption.className = "PumpSubtitle"; //The class name is being set to style the caption.
      var clickCounter=0; //Initialize the clickCounter variable in 0.
      //Appending the created element image to the div with the detectedPumps id and adding a click event listener.(Appending detected pumps graphicaly).
      document.getElementById("detectedPumps").appendChild(image).addEventListener("click", function() 
      {
        if(clickCounter==0) //This part of program will be executed after the first click on the image only.
        {
          figure.appendChild(caption);  //Appending the figcaption object to figure object.
          figure.appendChild(image);  //Appending the image object to figure object.
          image.className = "Pump1Added"; //The class name is being set to style the image. (linking the correct style to the image).
          lastPumpClick=1;  //Informing the system that the last click given occured on the pump 1.
          clickCounter++; //Registering the click to the click Counter.
          
          if(activePumps == 0)  //In case of there is not any activated pump.
          {
            //Appending the figure to the element with addedPump1 id and adding a click event listener. (Informing that the last pump clicked is Pump 1). 
            document.getElementById("addedPump1").appendChild(figure).addEventListener("click", function(){lastPumpClick=1});
            activePumps = 1;  //Registering the activation of 1 pump.
          }
          else
          {
            if(activePumps == 1)  //In case of there is 1 activated pump.
            {
              //Appending the figure to element with addedPump2 id and adding a click event listener. (Informing that the last pump clicked is Pump 2).
              document.getElementById("addedPump2").appendChild(figure).addEventListener("click", function(){lastPumpClick=2});
              image.className = "Pump2Added"; //The class name is being set to style the image. (linking the correct style to the image).
              lastPumpClick=2  //Informing the system that the last click given occured on the pump 2.
              activePumps = 2;  //Registering the activation of 2 pumps.
            }
          }    
        }
      })             
      break;

      case "nozzle":  //In case of nozzle type.
        image.src = "/img/PumpNozzle.jpg";  //The source of image is being defined in the image variable.
        image.className = "NozzleDetected"; //The class name is being set to style the image.(linking the correct style to the image).
        caption.className = "NozzleSubtitle"; //The class name is being set to style the caption.
        //Appending the created element image to the div with detectedNozzles id and adding a click event listener.(Append detected nozzles graphicaly).
        document.getElementById("detectedNozzles").appendChild(image).addEventListener("click", function() 
        {
          figure.appendChild(caption);  //Appending the figcaption object to figure object.
          figure.appendChild(image);  //Appending the image object to figure object.
          switch (lastPumpClick)  //Checking the last pump was clicked.
          {
            case 0: //No pumps clicked.
              window.alert("Favor iniciar a aplicação através da ativação de uma bomba.");  //Message requesting that the user active a pump.
              break;
          
            case 1: //In case a pump be active.
            if(nozzlesConnectedToPump1 < 4) //Checking if there is space to connect the the nozzle.(The max capacity is 4 nozzles per pump).
              { 
                image.className = "nozzlesConnectedImageToPump1"; //The class name is being set to style the image.
                //Appending the created element figure to the pump1 connected nozzles group.               
                document.getElementById("Pump1AddedNozzles").appendChild(figure);
                nozzlesConnectedToPump1++;  //Informing the system that a nozzle as connected to the Pump1.       
                break;
              }
              else
              {
                if(document.getElementById("addedPump2").hasChildNodes == true) //Checking if the pump2 has been activated.
                {
                  image.className = "nozzlesConnectedImageToPump2"; //The class name is being set to style the image.
                  //Appending the created element figure to the pump2 connected nozzles group.
                  document.getElementById("Pump2AddedNozzles").appendChild(figure);             
                  nozzlesConnectedToPump2++;  //Informing the system that a nozzle as connected to the Pump2. 
                  break;
                }
                else
                {
                  //Message requesting that the user active another pump because there is not any activated pump with available capacity.
                  window.alert("Não há bombas ativas com capacidade disponível para conexão com este bico. Para continuar, favor ativar mais uma bomba.");
                  //Appending the image element to element with detectedNozzles id and adding a click event listener.(Append detected nozzles graphicaly).
                  document.getElementById("detectedNozzles").appendChild(image).addEventListener("click", function()
                  {
                    //Appending the created element figure to the pump2 connected nozzles group.
                    document.getElementById("Pump2AddedNozzles").appendChild(figure);             
                    nozzlesConnectedToPump2++;  //Informing the system that a nozzle as connected to the Pump2. 
                  })
                  break;
                }
              }
              break;
            
              case 2: //In case of the 2 pumps be active.
                if(nozzlesConnectedToPump2 < 4) //Checking if there is space to connect the the nozzle.(The max capacity is 4 nozzles per pump).
                {
                  image.className = "nozzlesConnectedImageToPump2"; //The class name is being set to style the image.
                  //Appending the created element figure to the pump2 connected nozzles group.
                  document.getElementById("Pump2AddedNozzles").appendChild(figure);       
                  nozzlesConnectedToPump2++;  //Informing the system that a nozzle as connected to the Pump2.
                }
                break;

              default:
                break;
            }})
          }
        }
    </script>
  </body>
</html>